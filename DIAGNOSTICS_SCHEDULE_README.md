# График диагностики оборудования

## Описание

Система для создания и управления годовым графиком диагностики оборудования с учетом ограничений:
- Смена длится 7 часов (настраивается)
- Только рабочие дни (исключаются выходные)
- Учитывается длительность диагностики каждой единицы оборудования
- Учитывается количество человек, которые могут произвести диагностику
- Сумма всех длительностей диагностик в день не превышает: количество человек × длительность смены
- График равномерно распределен на весь год

## Установка

1. Выполните SQL скрипт для создания таблиц:
```sql
source create_diagnostics_schedule_tables.sql
```

2. Перезапустите приложение

## Использование

### Создание графика на год

1. Перейдите на страницу "График диагностики оборудования" (Диагностика → Графики → График диагностики оборудования)
2. Нажмите "Создать график на год"
3. Заполните форму:
   - Год
   - Количество человек
   - Длительность смены (по умолчанию 7 часов)
   - Добавьте оборудование с указанием количества диагностик каждого типа:
     - B - Вибродиагностика (60 минут)
     - K - Диагностика конденсатоотводчиков (30 минут)
     - y - Диагностики утечек воздуха (45 минут)
     - T - Тепловизионная диагностика (30 минут)
4. Нажмите "Создать график"

Система автоматически:
- Распределит все диагностики равномерно на рабочие дни года
- Учтет ограничения по количеству человек и длительности смены
- Проверит, что все диагностики помещаются в доступное время

### Просмотр графика

1. Выберите год из выпадающего списка
2. Выберите месяц
3. Нажмите "Загрузить месяц"

График отображается в виде таблицы:
- Строки - оборудование
- Столбцы - даты месяца
- Ячейки содержат коды типов диагностики (B, K, y, T)
- Цвета соответствуют типам диагностики:
  - Желтый (#FFD700) - Вибродиагностика
  - Зеленый (#90EE90) - Конденсатоотводчики и утечки воздуха
  - Оранжевый (#FFA500) - Тепловизионная диагностика

### Статистика

На странице отображается статистика:
- Общее количество запланированных диагностик
- Количество выполненных диагностик
- Процент выполнения
- Статистика по каждому типу диагностики

### Редактирование графика

Функция редактирования графика по месяцам будет реализована в следующей версии.

## API Endpoints

### Core Service (assistant-core)

- `GET /api/diagnostics-schedule` - Получить все графики
- `GET /api/diagnostics-schedule/year/{year}` - Получить график по году
- `GET /api/diagnostics-schedule/{scheduleId}/month/{month}` - Получить график на месяц
- `POST /api/diagnostics-schedule/create` - Создать график на год
- `PUT /api/diagnostics-schedule/{scheduleId}/month/{month}` - Обновить график на месяц
- `GET /api/diagnostics-schedule/types` - Получить все типы диагностики
- `GET /api/diagnostics-schedule/{scheduleId}/stats` - Получить статистику по графику

### Web Service (assistant-web)

Все endpoints проксируются через `/api/diagnostics-schedule/*`

## Структура базы данных

### diagnostics_types
- `id` - ID типа
- `code` - Код типа (B, K, y, T)
- `name` - Название типа
- `duration_minutes` - Длительность в минутах
- `color_code` - Цвет для отображения
- `is_active` - Активен ли тип

### diagnostics_schedules
- `id` - ID графика
- `year` - Год
- `shift_duration_hours` - Длительность смены в часах
- `workers_count` - Количество человек
- `created_at` - Дата создания
- `updated_at` - Дата обновления

### diagnostics_schedule_entries
- `id` - ID записи
- `schedule_id` - ID графика
- `equipment` - Оборудование
- `area` - Участок
- `diagnostics_type_id` - ID типа диагностики
- `scheduled_date` - Запланированная дата
- `is_completed` - Выполнена ли диагностика
- `completed_date` - Дата выполнения
- `notes` - Заметки

## Алгоритм распределения

1. Вычисляется общее количество рабочих дней в году (исключая выходные)
2. Вычисляется общее количество доступных часов: рабочие дни × длительность смены × количество человек
3. Вычисляется общее количество часов, необходимых для всех диагностик
4. Проверяется, что необходимое время не превышает доступное
5. Задачи перемешиваются для равномерного распределения
6. Задачи распределяются по дням с учетом ограничений:
   - Сумма длительностей в день не превышает доступное время
   - Приоритет отдается дням с минимальной загрузкой

## Рекомендации по использованию

1. **Создание графика**: Создавайте график на год в начале года или заранее
2. **Планирование**: Учитывайте, что система распределяет диагностики равномерно, но можно вручную редактировать график по месяцам
3. **Типы диагностики**: При необходимости можно добавить новые типы диагностики в таблицу `diagnostics_types`
4. **Мониторинг**: Регулярно проверяйте статистику выполнения для контроля процесса

