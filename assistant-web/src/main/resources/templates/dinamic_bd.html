<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Динамика поломок</title>
    <link rel="stylesheet" href="static/styles/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 6px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .filter-control {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .multi-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .multi-select-button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .multi-select-button:hover {
            border-color: #e74c3c;
        }
        
        .multi-select-button::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s;
        }
        
        .multi-select-button.open::after {
            transform: rotate(180deg);
        }
        
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .multi-select-dropdown.open {
            display: block;
        }
        
        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .multi-select-option:last-child {
            border-bottom: none;
        }
        
        .multi-select-option:hover {
            background-color: #f5f5f5;
        }
        
        .multi-select-option input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .multi-select-option label {
            cursor: pointer;
            margin: 0;
            flex: 1;
        }
        
        .btn-apply {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            grid-column: 1 / -1;
            margin-top: 10px;
        }
        
        .btn-apply:hover {
            background-color: #c0392b;
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #3498db;
        }
        
        .error {
            display: none;
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="logo">
            <img src="static/images/LogoPirelli3.png" alt="Логотип компании">
        </div>

        <div class="nav-container">
            <ul class="nav-menu">
                <li class="has-submenu">
                    <a href="#">Инфопанель</a>
                    <ul class="submenu">
                        <li><a href="/dashboard">Показатели Online</a></li>
                        <li><a href="/dashboard_graf">Показатели Online График</a></li>
                        <li><a href="/final">ИТОГИ</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="/">Главная</a>
                </li>
                <li class="has-submenu">
                    <a href="#">Поломки</a>
                    <ul class="submenu">
                        <li><a href="/dinamic_bd">Динамика</a></li>
                        <li><a href="/bdav">Динамика BD/AV</a></li>
                        <li><a href="/failures">Заявки на поломки</a></li>
                        <li><a href="/top-causes">Топ причин</a></li>
                        <li class="has-submenu">
                            <a href="/top-causes">Топ поломок</a>
                            <ul class="submenu">
                                <li><a href="/top-equipment">Оборудование</a></li>
                                <li><a href="/top_areas">Участки</a></li>
                            </ul>
                        </li>
                        <li><a href="/gantt">Диаграмма Ганта</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">ППР</a>
                    <ul class="submenu">
                        <li><a href="#">Динамика</a></li>
                        <li><a href="#">Отчеты</a></li>
                        <li><a href="#">Tag-PM-BD</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">Диагностика</a>
                    <ul class="submenu">
                        <li><a href="#">Отчёты</a></li>
                        <li><a href="#">Динамика</a></li>
                        <li><a href="#">Пневматика</a></li>
                        <li><a href="#">Чек-листы</a></li>
                        <li class="has-submenu">
                            <a href="#">Графики</a>
                            <ul class="submenu">
                                <li class="has-submenu">
                                    <a href="#">Год</a>
                                    <ul class="submenu">
                                        <li class="has-submenu">
                                            <a href="#">2025</a>
                                            <ul class="submenu">
                                                <li><a href="#">Январь</a></li>
                                                <li><a href="#">Февраль</a></li>
                                                <li><a href="#">Март</a></li>
                                                <li><a href="#">Апрель</a></li>
                                                <li><a href="#">Май</a></li>
                                                <li><a href="#">Июнь</a></li>
                                                <li><a href="#">Июль</a></li>
                                                <li><a href="#">Август</a></li>
                                                <li><a href="#">Сентябрь</a></li>
                                                <li><a href="#">Октябрь</a></li>
                                                <li><a href="#">Ноябрь</a></li>
                                                <li><a href="#">Декабрь</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">Ассистент KVANT AI </a>
                    <ul class="submenu">
                        <li><a href="/chat">Чат с ассистентом</a></li>
                        <li><a href="/long_report">Отчеты</a></li>
                        <li><a href="/manuals">Мануалы</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>


    <div class="total-content">
        <div class="header">
            <div class="user_logo">
                Привет, <a href="#">user</a>
            </div>
        </div>

        <div class="main-content">
            <style>
                .pm-row { display: grid; grid-template-columns: 1fr 1fr; grid-gap: 16px; }
                .pm-row .table-container, .pm-row .chart-container { height: 100%; }
                #resizablePm { height: 100% !important; }
            </style>
            <div class="container">
                <h1>Динамика поломок оборудования</h1>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="year">Год:</label>
                        <div class="multi-select" id="year-multiselect">
                            <button type="button" class="multi-select-button" id="year-button">
                                <span id="year-text">Все</span>
                            </button>
                            <div class="multi-select-dropdown" id="year-dropdown">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="year-all" value="all" checked>
                                    <label for="year-all">Все</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="month">Месяц:</label>
                        <div class="multi-select" id="month-multiselect">
                            <button type="button" class="multi-select-button" id="month-button">
                                <span id="month-text">Все</span>
                            </button>
                            <div class="multi-select-dropdown" id="month-dropdown">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="month-all" value="all" checked>
                                    <label for="month-all">Все</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="week">Неделя:</label>
                        <div class="multi-select" id="week-multiselect">
                            <button type="button" class="multi-select-button" id="week-button">
                                <span id="week-text">Все</span>
                            </button>
                            <div class="multi-select-dropdown" id="week-dropdown">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="week-all" value="all" checked>
                                    <label for="week-all">Все</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="area">Участок:</label>
                        <div class="multi-select" id="area-multiselect">
                            <button type="button" class="multi-select-button" id="area-button">
                                <span id="area-text">Все участки</span>
                            </button>
                            <div class="multi-select-dropdown" id="area-dropdown">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="area-all" value="all" checked>
                                    <label for="area-all">Все участки</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="equipment">Оборудование:</label>
                        <div class="multi-select" id="equipment-multiselect">
                            <button type="button" class="multi-select-button" id="equipment-button">
                                <span id="equipment-text">Всё оборудование</span>
                            </button>
                            <div class="multi-select-dropdown" id="equipment-dropdown">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="equipment-all" value="all" checked>
                                    <label for="equipment-all">Всё оборудование</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="failure-type">Тип поломки:</label>
                        <div class="multi-select" id="failure-type-multiselect">
                            <button type="button" class="multi-select-button" id="failure-type-button">
                                <span id="failure-type-text">Все</span>
                            </button>
                            <div class="multi-select-dropdown" id="failure-type-dropdown">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="failure-type-all" value="all" checked>
                                    <label for="failure-type-all">Все</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="apply-filters" class="btn-apply">Применить фильтры</button>
                </div>
                
                <div class="loading" id="loading">Загрузка данных...</div>
                <div class="error" id="error"></div>
                
                <div class="charts-wrapper" style="display: flex; gap: 20px; height: 580px;">
                    <div class="charts-column" style="flex: 2; position: relative;">
                        <div class="chart-controls" style="position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; gap: 5px;">
                            <button id="toggleChart" class="btn-toggle" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                Показать количество
                            </button>
                            <button id="toggleChartType" class="btn-toggle" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                Накопительная
                            </button>
                        </div>
                        <div class="chart-container" style="height: calc(100% - 40px); padding: 20px; padding-top: 50px;">
                            <canvas id="mainChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    <div class="legend-column" style="flex: 1; padding: 20px; background: #f8f9fa; border-radius: 6px; display: flex; flex-direction: column;">
                        <h4 style="margin-top: 0; margin-bottom: 15px;">Легенда</h4>
                        <div id="customLegend" style="overflow-y: auto; flex: 1;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mainChart = null;
        let currentMode = 'downtime';
        let chartType = 'line';
        let chartData = null;

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadInitialData();
        });
        
        function setupEventListeners() {
            // Настройка множественного выбора для года
            setupMultiSelect('year', function() {
                loadMonths();
            });
            
            // Настройка множественного выбора для месяца
            setupMultiSelect('month', function() {
                loadWeeks();
            });
            
            // Настройка множественного выбора для недели
            setupMultiSelect('week');
            
            // Настройка множественного выбора для участка
            setupMultiSelect('area', function() {
                loadEquipment(getSelectedValues('area'));
            });
            
            // Настройка множественного выбора для оборудования
            setupMultiSelect('equipment');
            
            // Настройка множественного выбора для типа поломки
            setupMultiSelect('failure-type');
            
            document.getElementById('apply-filters').addEventListener('click', function() {
                applyFilters();
            });
            
            document.getElementById('toggleChart').addEventListener('click', function() {
                toggleChartMode();
            });
            
            document.getElementById('toggleChartType').addEventListener('click', function() {
                toggleChartType();
            });
        }
        
        function setupMultiSelect(prefix, onChangeCallback) {
            const button = document.getElementById(prefix + '-button');
            const dropdown = document.getElementById(prefix + '-dropdown');
            const text = document.getElementById(prefix + '-text');
            const allCheckbox = document.getElementById(prefix + '-all');
            
            // Обработчик клика по кнопке
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleDropdown(prefix);
            });
            
            // Обработчик клика по чекбоксу "Все"
            allCheckbox.addEventListener('change', function() {
                const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:not(#' + prefix + '-all)');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
                updateButtonText(prefix);
                if (onChangeCallback) onChangeCallback();
            });
            
            // Обработчики для остальных чекбоксов
            dropdown.addEventListener('change', function(e) {
                if (e.target.type === 'checkbox' && e.target.id !== prefix + '-all') {
                    const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:checked:not(#' + prefix + '-all)');
                    allCheckbox.checked = checkedBoxes.length === 0;
                    updateButtonText(prefix);
                    if (onChangeCallback) onChangeCallback();
                }
            });
            
            // Закрытие при клике вне элемента
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#' + prefix + '-multiselect')) {
                    closeDropdown(prefix);
                }
            });
        }
        
        function toggleDropdown(prefix) {
            const button = document.getElementById(prefix + '-button');
            const dropdown = document.getElementById(prefix + '-dropdown');
            
            // Закрыть все остальные выпадающие списки
            document.querySelectorAll('.multi-select-dropdown.open').forEach(dd => {
                if (dd.id !== prefix + '-dropdown') {
                    dd.classList.remove('open');
                    dd.previousElementSibling.classList.remove('open');
                }
            });
            
            dropdown.classList.toggle('open');
            button.classList.toggle('open');
        }
        
        function closeDropdown(prefix) {
            const button = document.getElementById(prefix + '-button');
            const dropdown = document.getElementById(prefix + '-dropdown');
            dropdown.classList.remove('open');
            button.classList.remove('open');
        }
        
        function updateButtonText(prefix) {
            const text = document.getElementById(prefix + '-text');
            const dropdown = document.getElementById(prefix + '-dropdown');
            const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:checked:not(#' + prefix + '-all)');
            
            if (checkedBoxes.length === 0) {
                const allCheckbox = document.getElementById(prefix + '-all');
                text.textContent = allCheckbox.checked ? 'Все' : 'Ничего не выбрано';
            } else if (checkedBoxes.length === 1) {
                text.textContent = checkedBoxes[0].nextElementSibling.textContent;
            } else {
                text.textContent = `Выбрано: ${checkedBoxes.length}`;
            }
        }
        
        function getSelectedValues(prefix) {
            const dropdown = document.getElementById(prefix + '-dropdown');
            const allCheckbox = document.getElementById(prefix + '-all');
            
            if (allCheckbox.checked) {
                return ['all'];
            }
            
            const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:checked:not(#' + prefix + '-all)');
            return Array.from(checkedBoxes).map(cb => cb.value);
        }
        
        async function loadEquipment(areas) {
            try {
                if (!areas || areas.includes('all')) {
                    // Загружаем все оборудование
                    const response = await fetch('/gantt/equipment');
                    const equipment = await response.json();
                    populateMultiSelect('equipment', equipment, 'machine_name', 'Всё оборудование');
                } else {
                    // Загружаем оборудование для выбранных участков
                    const equipmentPromises = areas.map(area => 
                        fetch(`/gantt/equipment?area=${encodeURIComponent(area)}`).then(r => r.json())
                    );
                    const equipmentArrays = await Promise.all(equipmentPromises);
                    const allEquipment = equipmentArrays.flat();
                    const uniqueEquipment = allEquipment.filter((item, index, self) => 
                        index === self.findIndex(t => t.machine_name === item.machine_name)
                    );
                    populateMultiSelect('equipment', uniqueEquipment, 'machine_name', 'Всё оборудование');
                }
            } catch (error) {
                console.error('Ошибка загрузки оборудования:', error);
            }
        }
        
        function populateMultiSelect(prefix, data, valueField, allText) {
            const dropdown = document.getElementById(prefix + '-dropdown');
            const allCheckbox = document.getElementById(prefix + '-all');
            
            // Очищаем все опции кроме "Все"
            const existingOptions = dropdown.querySelectorAll('.multi-select-option:not(:first-child)');
            existingOptions.forEach(option => option.remove());
            
            // Добавляем новые опции
            data.forEach(item => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                const value = item[valueField];
                const displayText = item[valueField];
                const safeId = `${prefix}-${value}`.replace(/[^a-zA-Z0-9-_]/g, '_');
                
                option.innerHTML = `
                    <input type="checkbox" id="${safeId}" value="${value}">
                    <label for="${safeId}">${displayText}</label>
                `;
                dropdown.appendChild(option);
            });
            
            // Обновляем текст кнопки
            updateButtonText(prefix);
        }
        
        async function loadInitialData() {
            showLoading(true);
            try {
                await Promise.all([
                    loadYears(),
                    loadAreas(),
                    loadFailureTypes()
                ]);
                await applyFilters();
            } catch (error) {
                showError('Ошибка загрузки данных: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function loadYears() {
            try {
                const response = await fetch('/dynamics/years');
                const years = await response.json();
                
                populateMultiSelect('year', years, 'year', 'Все');
                
                // Устанавливаем текущий год по умолчанию
                const currentYear = new Date().getFullYear().toString();
                const safeId = `year-${currentYear}`.replace(/[^a-zA-Z0-9-_]/g, '_');
                const currentYearCheckbox = document.getElementById(safeId);
                if (currentYearCheckbox) {
                    currentYearCheckbox.checked = true;
                    document.getElementById('year-all').checked = false;
                    updateButtonText('year');
                }
            } catch (error) {
                console.error('Ошибка загрузки годов:', error);
            }
        }
        
        async function loadMonths() {
            const years = getSelectedValues('year');
            if (years.includes('all')) return;
            
            try {
                const response = await fetch(`/dynamics/months?year=${years.join(',')}`);
                const months = await response.json();
                
                const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                
                const monthsWithNames = months.map(item => ({
                    month: item.month,
                    monthName: monthNames[item.month - 1]
                }));
                
                populateMultiSelect('month', monthsWithNames, 'monthName', 'Все');
                loadWeeks();
            } catch (error) {
                console.error('Ошибка загрузки месяцев:', error);
            }
        }
        
        async function loadWeeks() {
            const years = getSelectedValues('year');
            const months = getSelectedValues('month');
            
            if (years.includes('all') || months.includes('all')) {
                const dropdown = document.getElementById('week-dropdown');
                const existingOptions = dropdown.querySelectorAll('.multi-select-option:not(:first-child)');
                existingOptions.forEach(option => option.remove());
                updateButtonText('week');
                return;
            }
            
            try {
                // Преобразуем названия месяцев обратно в номера
                const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                const monthNumbers = months.map(monthName => {
                    const index = monthNames.indexOf(monthName);
                    return index + 1;
                });
                
                const response = await fetch(`/dynamics/weeks?year=${years.join(',')}&month=${monthNumbers.join(',')}`);
                const weeks = await response.json();
                
                populateMultiSelect('week', weeks, 'week', 'Все');
            } catch (error) {
                console.error('Ошибка загрузки недель:', error);
            }
        }
        
        async function loadAreas() {
            try {
                const response = await fetch('/gantt/areas');
                const areas = await response.json();
                
                populateMultiSelect('area', areas, 'area', 'Все участки');
            } catch (error) {
                console.error('Ошибка загрузки участков:', error);
            }
        }
        
        async function loadFailureTypes() {
            try {
                const response = await fetch('/dynamics/failure-types');
                const types = await response.json();
                
                populateMultiSelect('failure-type', types, 'cause', 'Все');
            } catch (error) {
                console.error('Ошибка загрузки типов поломок:', error);
            }
        }
        
        async function applyFilters() {
            showLoading(true);
            try {
                const months = getSelectedValues('month');
                const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                
                let monthNumbers = months;
                if (!months.includes('all')) {
                    monthNumbers = months.map(monthName => {
                        const index = monthNames.indexOf(monthName);
                        return index + 1;
                    });
                }
                
                const params = {
                    year: getSelectedValues('year'),
                    month: monthNumbers,
                    week: getSelectedValues('week'),
                    area: getSelectedValues('area'),
                    equipment: getSelectedValues('equipment'),
                    failureType: getSelectedValues('failure-type')
                };
                
                console.log('Параметры фильтрации:', params); // Добавим логирование для отладки
                
                const data = await fetchDynamicsData(params);
                console.log('Полученные данные:', data); // Добавим логирование для отладки
                
                generateChart(data, params);
            } catch (error) {
                console.error('Ошибка применения фильтров:', error); // Добавим детальное логирование
                showError('Ошибка применения фильтров: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function fetchDynamicsData(params) {
            const url = new URL('/dynamics/data', window.location.origin);
            Object.keys(params).forEach(key => {
                if (params[key] && params[key].length > 0 && !params[key].includes('all')) {
                    params[key].forEach(value => {
                        url.searchParams.append(key, value.toString());
                    });
                }
            });
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }
        
        function generateChart(data, params) {
            const labels = generateLabels(data, params);
            chartData = {
                labels: labels,
                downtimeDatasets: generateDowntimeDatasets(data, labels),
                countDatasets: generateCountDatasets(data, labels),
                params: params
            };
            
            createMainChart();
            createCustomLegend(chartData.downtimeDatasets);
        }
        
        function createMainChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (mainChart) {
                mainChart.destroy();
            }
            
            const datasets = currentMode === 'downtime' ? chartData.downtimeDatasets : chartData.countDatasets;
            const title = currentMode === 'downtime' ? 'Динамика времени простоя' : 'Количество вызовов';
            const yAxisTitle = currentMode === 'downtime' ? 'Общее время простоя (часы)' : 'Количество вызовов';
            
            mainChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: chartData.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: chartType === 'bar',
                            title: {
                                display: true,
                                text: yAxisTitle
                            }
                        },
                        x: {
                            stacked: chartType === 'bar',
                            title: {
                                display: true,
                                text: getXAxisTitle(chartData.params)
                            }
                        }
                    }
                }
            });
        }
        
        function createCustomLegend(datasets) {
            const legendContainer = document.getElementById('customLegend');
            legendContainer.innerHTML = '';
            
            datasets.forEach(dataset => {
                const legendItem = document.createElement('div');
                legendItem.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;';
                
                const colorBox = document.createElement('div');
                colorBox.style.cssText = `width: 20px; height: 3px; background-color: ${dataset.borderColor}; margin-right: 8px; border-radius: 2px;`;
                
                const label = document.createElement('span');
                label.textContent = dataset.label;
                label.style.fontSize = '12px';
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legendContainer.appendChild(legendItem);
                
                legendItem.addEventListener('click', function() {
                    const datasetIndex = mainChart.data.datasets.findIndex(d => d.label === dataset.label);
                    if (datasetIndex !== -1) {
                        const meta = mainChart.getDatasetMeta(datasetIndex);
                        meta.hidden = !meta.hidden;
                        legendItem.style.opacity = meta.hidden ? '0.5' : '1';
                        mainChart.update();
                    }
                });
            });
        }
        
        function toggleChartMode() {
            currentMode = currentMode === 'downtime' ? 'count' : 'downtime';
            const button = document.getElementById('toggleChart');
            button.textContent = currentMode === 'downtime' ? 'Показать количество' : 'Показать время';
            
            if (chartData) {
                createMainChart();
            }
        }
        
        function toggleChartType() {
            chartType = chartType === 'line' ? 'bar' : 'line';
            const button = document.getElementById('toggleChartType');
            button.textContent = chartType === 'line' ? 'Накопительная' : 'Линейная';
            
            if (chartData) {
                createMainChart();
            }
        }
        
        function generateLabels(data, params) {
            const uniqueLabels = [...new Set(data.map(item => item.period_label))].sort((a, b) => a - b);
            return uniqueLabels;
        }
        
        function generateDowntimeDatasets(data, labels) {
            const uniqueTypes = [...new Set(data.map(item => item.failure_type))].filter(type => type).sort();
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A', '#85929E', '#D7BDE2', '#A9DFBF',
                '#F9E79F', '#AED6F1', '#F5B7B1', '#D5A6BD', '#A3E4D7', '#F4D03F', '#AEB6BF', '#E8DAEF',
                '#ABEBC6', '#FCF3CF', '#D6EAF8', '#FADBD8', '#E6B0AA', '#B2DFDB', '#FFF9C4', '#C8E6C9'
            ];
            
            return uniqueTypes.map((type, index) => {
                const chartData = labels.map(label => {
                    const items = data.filter(item => 
                        item.failure_type === type && 
                        item.period_label == label
                    );
                    return items.reduce((sum, item) => sum + (parseFloat(item.total_downtime) || 0), 0);
                });
                
                return {
                    label: type,
                    data: chartData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '80',
                    tension: 0.1,
                    borderWidth: 2
                };
            });
        }
        
        function generateCountDatasets(data, labels) {
            const uniqueTypes = [...new Set(data.map(item => item.failure_type))].filter(type => type).sort();
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A', '#85929E', '#D7BDE2', '#A9DFBF',
                '#F9E79F', '#AED6F1', '#F5B7B1', '#D5A6BD', '#A3E4D7', '#F4D03F', '#AEB6BF', '#E8DAEF',
                '#ABEBC6', '#FCF3CF', '#D6EAF8', '#FADBD8', '#E6B0AA', '#B2DFDB', '#FFF9C4', '#C8E6C9'
            ];
            
            return uniqueTypes.map((type, index) => {
                const chartData = labels.map(label => {
                    const items = data.filter(item => 
                        item.failure_type === type && 
                        item.period_label == label
                    );
                    return items.reduce((sum, item) => sum + (parseInt(item.failure_count) || 0), 0);
                });
                
                return {
                    label: type,
                    data: chartData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '80',
                    tension: 0.1,
                    borderWidth: 2
                };
            });
        }
        
        function getXAxisTitle(params) {
            if (params.week && params.week.length > 0 && !params.week.includes('all')) {
                return 'Дни месяца';
            } else if (params.month && params.month.length > 0 && !params.month.includes('all')) {
                return 'Номера недель';
            } else if (params.year && params.year.length > 0 && !params.year.includes('all')) {
                return 'Месяцы';
            } else {
                return 'Годы';
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
    </script>

</body>

</html>