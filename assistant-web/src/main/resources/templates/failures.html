<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair AI Assistant</title>
    <link rel="stylesheet" href="static/styles/style.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <style>
        .dataTables_wrapper {
            font-size: 12px;
            width: 100%;
            overflow: visible !important;
        }
        /* Фиксируем страницу в пределах видимой области */
        html, body { height: 100%; overflow: hidden !important; }
        /* Основной контент прокручиваемый только внутри по вертикали при необходимости */
        .main-content { height: calc(100vh - 80px);width: 85%; overflow-y: auto !important; overflow-x: visible !important; padding-right: 100px; }

        /* Родители не должны обрезать полосы прокрутки */
        .total-content, .container, .row { overflow: visible !important; }
        /* Force scrollbars inside DataTables area */
        .dataTables_scroll { overflow: auto !important; }
        .dataTables_scrollBody { overflow-x: scroll !important; overflow-y: auto !important; height: 60vh !important; max-height: 60vh !important; }
        /* Ensure inner tables are wider than viewport to trigger horizontal scroll */
        .dataTables_scrollHeadInner, .dataTables_scrollBody > table { min-width: 2200px !important; }
        .dataTables_scrollHead, .dataTables_scrollBody {
            border: 1px solid #ddd;
        }
        table.dataTable thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
        table.dataTable tbody td {
            border-bottom: 1px solid #dee2e6;
            padding: 8px;
            vertical-align: top;
            white-space: nowrap;
        }
        .dataTables_length, .dataTables_filter { margin-bottom: 10px; }
        .dataTables_info { margin-top: 10px; }
        .dataTables_paginate { margin-top: 10px; display: block !important; visibility: visible !important; }
        /* Details row styles */
        td.details-control { cursor: pointer; }
        tr.shown td.details-control::before { content: "− "; font-weight: bold; }
        td.details-control::before { content: "+ "; font-weight: bold; }
        table.details-table { width: 100%; border-collapse: collapse; }
        table.details-table th, table.details-table td { border: 1px solid #e1e1e1; padding: 6px 8px; text-align: left; white-space: normal; }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 16px 0 8px 0; padding: 15px; background-color: #f5f5f5; border-radius: 6px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; margin-bottom: 5px; color: #333; }
        .filter-control { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .btn-apply { background-color: #e74c3c; color: white; border: none; border-radius: 4px; padding: 10px 15px; cursor: pointer; font-weight: 600; grid-column: 1 / -1; margin-top: 10px; }
        .btn-apply:hover { background-color: #c0392b; }
        /* Keep pagination visible and not offscreen */
        .dataTables_wrapper .dataTables_paginate { float: left !important; display: flex !important; gap: 6px; }
        .dataTables_wrapper .dataTables_info { float: right !important; }
        .dataTables_wrapper .dataTables_length { float: left !important; }
        .dataTables_wrapper .dataTables_filter { float: right !important; }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="logo">
            <img src="static/images/LogoPirelli3.png" alt="Логотип компании">
        </div>

        <div class="nav-container">
            <ul class="nav-menu">
                <li class="has-submenu">
                    <a href="/dashboard">Инфопанель</a>
                </li>
                <li class="has-submenu">
                    <a href="/">Главная</a>
                </li>
                <li class="has-submenu">
                    <a href="#">Поломки</a>
                    <ul class="submenu">
                        <li><a href="/dinamic_bd">Динамика</a></li>
                        <li><a href="/bdav">Динамика BD/AV</a></li>
                        <li><a href="/failures">Заявки на поломки</a></li>
                        <li><a href="/top-causes">Топ причин</a></li>
                        <li class="has-submenu">
                            <a href="/top-causes">Топ поломок</a>
                            <ul class="submenu">
                                <li><a href="/top-equipment">Оборудование</a></li>
                                <li><a href="/top_areas">Участки</a></li>
                            </ul>
                        </li>
                        <li><a href="/gantt">Диаграмма Ганта</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">ППР</a>
                    <ul class="submenu">
                        <li><a href="#">Динамика</a></li>
                        <li><a href="#">Отчеты</a></li>
                        <li><a href="#">Tag-PM-BD</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">Диагностика</a>
                    <ul class="submenu">
                        <li><a href="#">Отчёты</a></li>
                        <li><a href="#">Динамика</a></li>
                        <li><a href="#">Пневматика</a></li>
                        <li><a href="#">Чек-листы</a></li>
                        <li class="has-submenu">
                            <a href="#">Графики</a>
                            <ul class="submenu">
                                <li class="has-submenu">
                                    <a href="#">Год</a>
                                    <ul class="submenu">
                                        <li class="has-submenu">
                                            <a href="#">2025</a>
                                            <ul class="submenu">
                                                <li><a href="#">Январь</a></li>
                                                <li><a href="#">Февраль</a></li>
                                                <li><a href="#">Март</a></li>
                                                <li><a href="#">Апрель</a></li>
                                                <li><a href="#">Май</a></li>
                                                <li><a href="#">Июнь</a></li>
                                                <li><a href="#">Июль</a></li>
                                                <li><a href="#">Август</a></li>
                                                <li><a href="#">Сентябрь</a></li>
                                                <li><a href="#">Октябрь</a></li>
                                                <li><a href="#">Ноябрь</a></li>
                                                <li><a href="#">Декабрь</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">Ассистент KVANT AI </a>
                    <ul class="submenu">
                        <li><a href="/chat">Чат с ассистентом</a></li>
                        <li><a href="/long_report">Отчеты</a></li>
                        <li><a href="/manuals">Мануалы</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>


    <div class="total-content">
        <div class="header">
            <div class="user_logo">
                Привет, <a href="#">user</a>
            </div>
        </div>

        <div class="main-content">
            <style>
                .pm-row { display: grid; grid-template-columns: 1fr 1fr; grid-gap: 16px; }
                .pm-row .table-container, .pm-row .chart-container { height: 100%; }
                #resizablePm { height: 100% !important; }
            </style>
            <div class="container">
                <div class="filters">
                    <div class="filter-group">
                        <label for="yearSelect">Год:</label>
                        <select id="yearSelect" class="filter-control"><option value="all">Все</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="monthSelect">Месяц:</label>
                        <select id="monthSelect" class="filter-control"><option value="all">Все</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="weekSelect">Неделя:</label>
                        <select id="weekSelect" class="filter-control"><option value="all">Все</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="areaSelect">Участок:</label>
                        <select id="areaSelect" class="filter-control"><option value="all">Все</option></select>
                    </div>
                    <button id="loadData" class="btn-apply">Загрузить</button>
                </div>
                <div class="row">
                    <div class="col">
                        <table id="failuresTable" class="display nowrap" style="width:100%; min-width: 2000px;">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>id</th>
                                    <th>mechanism_node</th>
                                    <th>additional_kit</th>
                                    <th>description</th>
                                    <th>code</th>
                                    <th>hp_bd</th>
                                    <th>start_bd_t1</th>
                                    <th>start_maint_t2</th>
                                    <th>stop_maint_t3</th>
                                    <th>stop_bd_t4</th>
                                    <th>machine_downtime</th>
                                    <th>ttr</th>
                                    <th>t2_minus_t1</th>
                                    <th>status</th>
                                    <th>maintainers</th>
                                    <th>comments</th>
                                    <th>cause</th>
                                    <th>failure_type</th>
                                    <th>area</th>
                                    <th>created_at</th>
                                    <th>date</th>
                                    <th>week_number</th>
                                    <th>month_name</th>
                                    <th>shift</th>
                                    <th>staff</th>
                                    <th>crew</th>
                                    <th>crew_de_facto</th>
                                    <th>production_day</th>
                                </tr>
                            </thead>
                            <tbody>                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="none">
        function formatDetailsRow(d) {
            var rows = Object.entries(d || {}).map(function(entry){
                var key = entry[0];
                var value = entry[1];
                if (value === null || value === undefined) { value = ''; }
                // Форматируем даты в подробной информации
                if (key.includes('_t') || key === 'created_at' || key === 'date') {
                    value = formatDateTime(value);
                }
                return '<tr><th>'+ key +'</th><td>'+ value +'</td></tr>';
            }).join('');
            return '<table class="details-table">' + rows + '</table>';
        }
        $(document).ready(function () {
            function formatDateTime(value) {
                if (!value) return '';
                const d = new Date(value);
                if (isNaN(d.getTime())) return value;
                const pad = (n) => String(n).padStart(2,'0');
                return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }

            function getWeekNumber(dateObj) {
                const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()))
                const dayNum = d.getUTCDay() || 7; // 1..7 (Mon..Sun)
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
                return weekNo;
            }

            var table = $('#failuresTable').DataTable({
                ajax: { 
                    url: '/dashboard/equipment-maintenance-records', 
                    dataSrc: function(json) {
                        // Фильтруем по текущему году по умолчанию
                        const currentYear = new Date().getFullYear();
                        return json.filter(row => {
                            const dt = new Date(row.start_bd_t1 || row.date);
                            return !isNaN(dt.getTime()) && dt.getFullYear() === currentYear;
                        });
                    }
                },
                autoWidth: false,
                columns: [
                    { className: 'details-control', orderable: false, data: null, defaultContent: '', width: '24px' },
                    { data: 'id', title: 'ID', width: '60px' },
                    { data: 'mechanism_node', title: 'Узел механизма', width: '150px' },
                    { data: 'additional_kit', title: 'Доп. комплект', width: '120px' },
                    { data: 'description', title: 'Описание', width: '200px' },
                    { data: 'code', title: 'Код', width: '80px' },
                    { data: 'hp_bd', title: 'HP BD', width: '80px' },
                    { data: 'start_bd_t1', title: 'Начало BD', width: '140px', render: function(d){ return formatDateTime(d); } },
                    { data: 'start_maint_t2', title: 'Начало ремонта', width: '140px', render: function(d){ return formatDateTime(d); } },
                    { data: 'stop_maint_t3', title: 'Окончание ремонта', width: '140px', render: function(d){ return formatDateTime(d); } },
                    { data: 'stop_bd_t4', title: 'Окончание BD', width: '140px', render: function(d){ return formatDateTime(d); } },
                    { data: 'machine_downtime', title: 'Время простоя', width: '100px' },
                    { data: 'ttr', title: 'TTR', width: '80px' },
                    { data: 't2_minus_t1', title: 'T2-T1', width: '80px' },
                    { data: 'status', title: 'Статус', width: '100px' },
                    { data: 'maintainers', title: 'Сервисники', width: '150px' },
                    { data: 'comments', title: 'Комментарии', width: '200px' },
                    { data: 'cause', title: 'Причина', width: '150px' },
                    { data: 'failure_type', title: 'Тип поломки', width: '120px' },
                    { data: 'area', title: 'Зона', width: '120px' },
                    { data: 'created_at', title: 'Создано', width: '140px', render: function(d){ return formatDateTime(d); } },
                    { data: 'date', title: 'Дата', width: '120px', render: function(d){ return formatDateTime(d).split(' ')[0]; } },
                    { data: 'week_number', title: 'Неделя', width: '90px' },
                    { data: 'month_name', title: 'Месяц', width: '120px' },
                    { data: 'shift', title: 'Смена', width: '80px' },
                    { data: 'staff', title: 'Персонал', width: '100px' },
                    { data: 'crew', title: 'Бригада', width: '100px' },
                    { data: 'crew_de_facto', title: 'Бригада де-факто', width: '120px' },
                    { data: 'production_day', title: 'Производственный день', width: '150px' }
                ],
                scrollX: true,
                scrollY: '60vh',
                scrollCollapse: true,
                paging: true,
                pagingType: 'full_numbers',
                dom: 'lfrtip',
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, 250, 500], [10, 25, 50, 100, 250, 500]],
                processing: true,
                deferRender: true,
                language: {
                    search: "Поиск:",
                    lengthMenu: "Показать _MENU_ записей",
                    info: "Показано с _START_ по _END_ из _TOTAL_ записей",
                    infoEmpty: "Нет записей для отображения",
                    infoFiltered: "(отфильтровано из _MAX_ записей)",
                    paginate: { 
                        first: "Первая", 
                        last: "Последняя", 
                        next: "Следующая", 
                        previous: "Предыдущая" 
                    },
                    processing: "Загрузка данных...",
                    emptyTable: "Нет данных для отображения",
                    zeroRecords: "Записи не найдены"
                },
                order: [[1, 'desc']],
                columnDefs: [
                    {
                        targets: [4, 15, 16],
                        render: function(data, type, row) {
                            if (type === 'display' && data && data.length > 50) {
                                return data.substr(0, 50) + '...';
                            }
                            return data;
                        }
                    }
                ]
            });

            let allData = []; // Хранилище всех данных

            // Заполнение фильтров после загрузки данных
            table.on('xhr', function(){
                allData = table.ajax.json() || [];
                populateFilters();
                // Устанавливаем текущий год по умолчанию
                $('#yearSelect').val(new Date().getFullYear());
            });

            function populateFilters() {
                const data = allData;
                const areas = Array.from(new Set(data.map(r => r.area).filter(Boolean))).sort();
                const years = Array.from(new Set(data.map(r => { const d = new Date(r.start_bd_t1 || r.date); return isNaN(new Date(d).getTime())? null : new Date(d).getFullYear(); }).filter(Boolean))).sort((a,b)=>a-b);
                $('#areaSelect').html('<option value="all">Все</option>' + areas.map(a=>`<option value="${a}">${a}</option>`).join(''));
                $('#yearSelect').html('<option value="all">Все</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join(''));
                // месяцы
                const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
                $('#monthSelect').html('<option value="all">Все</option>' + monthNames.map((n,i)=>`<option value="${i+1}">${n}</option>`).join(''));
                $('#weekSelect').html('<option value="all">Все</option>');
            }

            // Функция загрузки данных с фильтрацией
            function loadFilteredData() {
                const year = $('#yearSelect').val();
                const month = $('#monthSelect').val();
                const week = $('#weekSelect').val();
                const area = $('#areaSelect').val();

                let filteredData = allData;

                if (year !== 'all') {
                    filteredData = filteredData.filter(row => {
                        const dt = new Date(row.start_bd_t1 || row.date);
                        return !isNaN(dt.getTime()) && dt.getFullYear() === Number(year);
                    });
                }

                if (month !== 'all') {
                    filteredData = filteredData.filter(row => {
                        const dt = new Date(row.start_bd_t1 || row.date);
                        return !isNaN(dt.getTime()) && (dt.getMonth() + 1) === Number(month);
                    });
                }

                if (week !== 'all') {
                    filteredData = filteredData.filter(row => {
                        const dt = new Date(row.start_bd_t1 || row.date);
                        return !isNaN(dt.getTime()) && getWeekNumber(dt) === Number(week);
                    });
                }

                if (area !== 'all') {
                    filteredData = filteredData.filter(row => row.area === area);
                }

                table.clear().rows.add(filteredData).draw();
            }

            // Обновляем недели при выборе месяца/года
            function refreshWeeks() {
                const year = $('#yearSelect').val();
                const month = $('#monthSelect').val();
                if (year === 'all' || month === 'all') { $('#weekSelect').html('<option value="all">Все</option>'); return; }
                const weeks = new Set();
                allData.forEach(r => {
                    const d = new Date(r.start_bd_t1 || r.date);
                    if (!isNaN(d.getTime()) && d.getFullYear() === Number(year) && (d.getMonth()+1) === Number(month)) {
                        weeks.add(getWeekNumber(d));
                    }
                });
                const opts = Array.from(weeks).sort((a,b)=>a-b).map(w=>`<option value="${w}">${w}</option>`).join('');
                $('#weekSelect').html('<option value="all">Все</option>' + opts);
            }

            $('#yearSelect, #monthSelect').on('change', refreshWeeks);
            $('#loadData').on('click', loadFilteredData);

            // Recalculate column widths to ensure horizontal scroll is applied
            table.columns.adjust();
            $(window).on('resize', function(){
                table.columns.adjust();
            });

            $('#failuresTable tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);
                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    row.child(formatDetailsRow(row.data())).show();
                    tr.addClass('shown');
                }
            });
        });
    </script>
</body>

</html>

