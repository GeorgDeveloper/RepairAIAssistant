<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair AI Assistant - Создание отчета диагностики</title>
    <link rel="stylesheet" href="/static/styles/style.css">
    <link rel="stylesheet" href="/static/styles/pm.css">
    <link rel="stylesheet" href="/static/styles/diagnostics-report-form.css">
    <script src="/static/jquery/jquery-3.6.0.min.js"></script>
</head>

<body>
    <!-- Use the navigation fragment -->
    <div th:replace="~{fragments/navigation :: nav}"></div>

    <div class="total-content">
        <div class="header">
            <div class="user_logo">
                Привет, <a href="#">user</a>
            </div>
        </div>

        <div class="main-content">
            <div class="container">
                <div class="content">
                    <h1>Создание отчета диагностики</h1>
                    
                    <form id="diagnosticsReportForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="detection_date">ДАТА ОБНАРУЖЕНИЯ *</label>
                            <input type="date" id="detection_date" name="detection_date" required>
                        </div>

                        <div class="form-group">
                            <label for="diagnostics_type">ТИП ДИАГНОСТИКИ *</label>
                            <select id="diagnostics_type" name="diagnostics_type" required>
                                <option value="">Выберите тип диагностики</option>
                                <option value="Акустическая">Акустическая</option>
                                <option value="Вибродиагностика">Вибродиагностика</option>
                                <option value="Конденсатоотводчики">Конденсатоотводчики</option>
                                <option value="Термодиагностика">Термодиагностика</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="area">УЧАСТОК *</label>
                            <select id="area" name="area" required>
                                <option value="">Выберите участок</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="equipment">ОБОРУДОВАНИЕ *</label>
                            <select id="equipment" name="equipment" required>
                                <option value="">Выберите оборудование</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="node">УЗЕЛ</label>
                            <input type="text" id="node" name="node" placeholder="Введите узел">
                        </div>

                        <div class="form-group">
                            <label for="malfunction">НЕИСПРАВНОСТЬ</label>
                            <textarea id="malfunction" name="malfunction" rows="3" placeholder="Опишите неисправность"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="additional_kit">ДОП. КОМПЛЕКТ</label>
                            <input type="text" id="additional_kit" name="additional_kit" placeholder="Введите доп. комплект">
                        </div>

                        <div class="form-group">
                            <label for="causes">ПРИЧИНЫ</label>
                            <textarea id="causes" name="causes" rows="3" placeholder="Опишите причины"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="photo">ФОТО</label>
                            <input type="file" id="photo" name="photo" accept="image/*">
                            <small>Можно загрузить изображение (JPG, PNG и т.д.)</small>
                        </div>

                        <div class="form-group">
                            <label for="document">ДОКУМЕНТ</label>
                            <input type="file" id="document" name="document" accept=".pdf,.doc,.docx">
                            <small>Можно загрузить документ (PDF, DOC, DOCX)</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-apply">Создать отчет</button>
                            <a href="/diagnostics-report" class="btn-cancel">Отмена</a>
                        </div>
                    </form>

                    <div id="message" style="display: none; margin-top: 20px; padding: 10px; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Простое заполнение полей из URL параметров (работает без jQuery)
        console.log('HTML загружен, начинаем заполнение полей...');
        console.log('Текущий URL:', window.location.href);
        
        // Сохраняем параметры для возврата
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const result = {};
            params.forEach(function(value, key) {
                try {
                    result[key] = decodeURIComponent(value);
                } catch (e) {
                    result[key] = value;
                }
            });
            return result;
        }
        
        const urlParams = getUrlParams();
        console.log('Параметры из URL:', urlParams);
        
        // Сохраняем для использования после загрузки jQuery
        window.scheduleReturnParams = {
            returnTo: urlParams['return_to'] || null,
            entryId: urlParams['entry_id'] || null,
            equipment: urlParams['equipment'] || null,
            area: urlParams['area'] || null,
            diagnosticsType: urlParams['diagnostics_type'] || null,
            detectionDate: urlParams['detection_date'] || null
        };
        console.log('Сохраненные параметры:', window.scheduleReturnParams);
    </script>
    <script src="/static/js/create_diagnostics_report.js" onerror="console.error('ОШИБКА ЗАГРУЗКИ СКРИПТА!')"></script>
    <script>
        // Заполнение полей после загрузки DOM
        function fillFormFields() {
            if (!window.scheduleReturnParams) {
                console.error('window.scheduleReturnParams не определен!');
                return;
            }
            
            const params = window.scheduleReturnParams;
            console.log('Заполнение полей из параметров:', params);
            
            // Заполняем дату обнаружения
            if (params.detectionDate) {
                const dateInput = document.getElementById('detection_date');
                if (dateInput) {
                    dateInput.value = params.detectionDate;
                    console.log('Дата установлена:', dateInput.value);
                }
            }
            
            // Заполняем тип диагностики
            if (params.diagnosticsType) {
                const typeSelect = document.getElementById('diagnostics_type');
                if (typeSelect) {
                    // Маппинг типов
                    const typeMapping = {
                        'Вибродиагностика': 'Вибродиагностика',
                        'Диагностика конденсатоотводчиков': 'Конденсатоотводчики',
                        'Конденсатоотводчики': 'Конденсатоотводчики',
                        'Диагностики утечек воздуха': 'Акустическая',
                        'Тепловизионная диагностика': 'Термодиагностика',
                        'Термодиагностика': 'Термодиагностика'
                    };
                    
                    let mappedType = typeMapping[params.diagnosticsType];
                    if (!mappedType) {
                        if (params.diagnosticsType.includes('Вибро') || params.diagnosticsType.includes('вибро')) {
                            mappedType = 'Вибродиагностика';
                        } else if (params.diagnosticsType.includes('Конденсат') || params.diagnosticsType.includes('конденсат')) {
                            mappedType = 'Конденсатоотводчики';
                        } else if (params.diagnosticsType.includes('Тепло') || params.diagnosticsType.includes('термо') || params.diagnosticsType.includes('Термо')) {
                            mappedType = 'Термодиагностика';
                        } else if (params.diagnosticsType.includes('Утеч') || params.diagnosticsType.includes('утеч') || params.diagnosticsType.includes('Акуст') || params.diagnosticsType.includes('акуст')) {
                            mappedType = 'Акустическая';
                        } else {
                            mappedType = params.diagnosticsType;
                        }
                    }
                    
                    typeSelect.value = mappedType;
                    console.log('Тип диагностики установлен:', typeSelect.value);
                }
            }
        }
        
        // Заполняем поля после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fillFormFields);
        } else {
            fillFormFields();
        }
        
        // Также пробуем заполнить после загрузки jQuery (если скрипт использует jQuery)
        setTimeout(fillFormFields, 500);
        setTimeout(fillFormFields, 1500);
    </script>
</body>

</html>

