<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Топ причин</title>
    <link rel="stylesheet" href="static/styles/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 6px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; margin-bottom: 6px; }
        .filter-control { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .btn-apply { background: #e74c3c; color: #fff; border: 0; border-radius: 4px; padding: 9px 14px; cursor: pointer; grid-column: 1 / -1; }
        .chart-row { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
        .chart-container { padding: 16px; background: #fff; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 560px; }
        .legend-container { padding: 16px; background: #fff; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .legend-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #eee; }
        .legend-item:last-child { border-bottom: 0; }
        .legend-left { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 10px; height: 10px; border-radius: 2px; display: inline-block; }
        .loading, .error { display: none; text-align: center; padding: 12px; }
        .error { color: #e74c3c; background: #ffefef; border-radius: 4px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); align-items: center; justify-content: center; }
        .modal-content { width: min(1000px, 92vw); height: 80vh; background: #fff; border-radius: 8px; padding: 16px; display: flex; flex-direction: column; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .modal-body { flex: 1; }
        .close-btn { border: 0; background: #e74c3c; color: #fff; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="logo">
            <img src="static/images/LogoPirelli3.png" alt="Логотип компании">
        </div>

        <div class="nav-container">
            <ul class="nav-menu">
                <li class="has-submenu"><a href="/dashboard">Дашборд</a></li>
                <li class="has-submenu"><a href="/">Главная</a></li>
                <li class="has-submenu">
                    <a href="#">Поломки</a>
                    <ul class="submenu">
                        <li><a href="/dinamic_bd">Динамика</a></li>
                        <li><a href="/failures">Заявки на поломки</a></li>
                        <li><a href="/top_causes">Топ причин</a></li>
                        <li><a href="/gantt">Диаграмма Ганта</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <div class="content">
        <h2>Топ причин простоев</h2>

        <div class="filters">
            <div class="filter-group">
                <label>Дата с</label>
                <input id="dateFrom" type="date" class="filter-control" />
            </div>
            <div class="filter-group">
                <label>Дата по</label>
                <input id="dateTo" type="date" class="filter-control" />
            </div>
            <div class="filter-group">
                <label>Номер недели</label>
                <select id="week" class="filter-control"></select>
            </div>
            <div class="filter-group">
                <label>Зона</label>
                <select id="area" class="filter-control"></select>
            </div>
            <div class="filter-group">
                <label>Оборудование</label>
                <select id="machine" class="filter-control"></select>
            </div>
            <div class="filter-group">
                <label>Тип поломки</label>
                <select id="failureType" class="filter-control"></select>
            </div>
            <button class="btn-apply" onclick="applyFilters()">Применить</button>
        </div>

        <div class="chart-row">
            <div class="chart-container">
                <canvas id="topChart"></canvas>
            </div>
            <div class="legend-container">
                <h3>Легенда</h3>
                <div id="legend"></div>
            </div>
        </div>

        <div id="loading" class="loading">Загрузка...</div>
        <div id="error" class="error"></div>

        <div id="drillModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="drillTitle">Детализация</h3>
                    <button class="close-btn" onclick="closeModal()">Закрыть</button>
                </div>
                <div class="modal-body">
                    <canvas id="drillChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiBase = '/top-causes';
        let chart;
        let drillChart;

        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadWeeks(), loadAreas(), loadFailureTypes()]);
            await loadMachines();
            await applyFilters();
            document.getElementById('area').addEventListener('change', loadMachines);
        });

        async function loadWeeks() {
            const res = await fetch(`${apiBase}/weeks`);
            const data = await res.json();
            const el = document.getElementById('week');
            el.innerHTML = '<option value="all">Все</option>';
            data.forEach(w => el.innerHTML += `<option value="${w.week_number}">${w.week_number}</option>`);
        }

        async function loadAreas() {
            const res = await fetch(`${apiBase}/areas`);
            const data = await res.json();
            const el = document.getElementById('area');
            el.innerHTML = '<option value="all">Все</option>';
            data.forEach(a => el.innerHTML += `<option value="${a.area}">${a.area}</option>`);
        }

        async function loadMachines() {
            const area = document.getElementById('area').value || 'all';
            const res = await fetch(`${apiBase}/machines?area=${encodeURIComponent(area)}`);
            const data = await res.json();
            const el = document.getElementById('machine');
            el.innerHTML = '<option value="all">Всё оборудование</option>';
            data.forEach(m => el.innerHTML += `<option value="${m.machine_name}">${m.machine_name}</option>`);
        }

        async function loadFailureTypes() {
            const res = await fetch(`${apiBase}/failure-types`);
            const data = await res.json();
            const el = document.getElementById('failureType');
            el.innerHTML = '<option value="all">Все</option>';
            data.forEach(t => el.innerHTML += `<option value="${t.failure_type}">${t.failure_type}</option>`);
        }

        async function applyFilters() {
            const params = new URLSearchParams();
            const df = document.getElementById('dateFrom').value;
            const dt = document.getElementById('dateTo').value;
            const w = document.getElementById('week').value;
            const a = document.getElementById('area').value;
            const m = document.getElementById('machine').value;
            const ft = document.getElementById('failureType').value;
            if (df) params.append('dateFrom', df);
            if (dt) params.append('dateTo', dt);
            if (w && w !== 'all') params.append('week', w);
            if (a && a !== 'all') params.append('area', a);
            if (m && m !== 'all') params.append('machine', m);
            if (ft && ft !== 'all') params.append('failureType', ft);
            params.append('limit', 30);

            const res = await fetch(`${apiBase}/data?${params.toString()}`);
            const data = await res.json();
            renderChart(data);
            renderLegend(data);
        }

        function renderChart(data) {
            const labels = data.map(d => d.cause);
            const downtime = data.map(d => Number(d.total_downtime_hours).toFixed(2));
            const counts = data.map(d => d.failure_count);
            const colors = labels.map((_, i) => `hsl(${(i*37)%360} 70% 55%)`);

            const ctx = document.getElementById('topChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Время простоя (ч)', data: downtime, backgroundColor: colors },
                        { label: 'Кол-во заявок', data: counts, backgroundColor: 'rgba(52, 152, 219, 0.45)' }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: { x: { beginAtZero: true } }
                }
            });

            document.getElementById('topChart').onclick = async (evt) => {
                const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                if (!points.length) return;
                const idx = points[0].index;
                const cause = labels[idx];
                await openDrilldown(cause);
            };
        }

        function renderLegend(data) {
            const container = document.getElementById('legend');
            container.innerHTML = '';
            const max = Math.max(...data.map(d => Number(d.total_downtime_hours)) , 1);
            data.forEach((d, i) => {
                const color = `hsl(${(i*37)%360} 70% 55%)`;
                const row = document.createElement('div');
                row.className = 'legend-item';
                row.innerHTML = `<div class="legend-left"><span class="legend-color" style="background:${color}"></span><span>${d.cause}</span></div><div>${Number(d.total_downtime_hours).toFixed(2)} ч | ${d.failure_count}</div>`;
                container.appendChild(row);
            });
        }

        function openModal(title){
            document.getElementById('drillTitle').textContent = title;
            document.getElementById('drillModal').style.display = 'flex';
        }
        function closeModal(){
            document.getElementById('drillModal').style.display = 'none';
            if (drillChart) { drillChart.destroy(); drillChart = null; }
        }

        async function openDrilldown(cause){
            openModal(`Причина: ${cause}`);
            const params = new URLSearchParams();
            const df = document.getElementById('dateFrom').value;
            const dt = document.getElementById('dateTo').value;
            const w = document.getElementById('week').value;
            const a = document.getElementById('area').value;
            if (df) params.append('dateFrom', df);
            if (dt) params.append('dateTo', dt);
            if (w && w !== 'all') params.append('week', w);
            if (a && a !== 'all') params.append('area', a);
            params.append('cause', cause);

            // level 1: machines by cause
            const machines = await (await fetch(`${apiBase}/drilldown/machines?${params}`)).json();
            renderDrillChart('По оборудованию', machines.map(m=>m.machine_name), machines.map(m=>Number(m.total_downtime_hours).toFixed(2)), machines.map(m=>m.failure_count), async (machineName)=>{
                // level 2: mechanisms for selected machine
                const p2 = new URLSearchParams(params);
                p2.append('machine', machineName);
                const nodes = await (await fetch(`${apiBase}/drilldown/mechanisms?${p2}`)).json();
                renderDrillChart(`Узел: ${machineName}`, nodes.map(n=>n.mechanism_node), nodes.map(n=>Number(n.total_downtime_hours).toFixed(2)), nodes.map(n=>n.failure_count));
            });
        }

        function renderDrillChart(title, labels, downtime, counts, onBarClick){
            const ctx = document.getElementById('drillChart').getContext('2d');
            if (drillChart) drillChart.destroy();
            drillChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [
                    { label: 'Время простоя (ч)', data: downtime, backgroundColor: 'rgba(231, 76, 60, .8)' },
                    { label: 'Кол-во заявок', data: counts, backgroundColor: 'rgba(52, 152, 219, 0.45)' }
                ]},
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
            });
            if (onBarClick){
                document.getElementById('drillChart').onclick = (evt)=>{
                    const points = drillChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                    if (!points.length) return;
                    const idx = points[0].index;
                    onBarClick(labels[idx]);
                };
            } else {
                document.getElementById('drillChart').onclick = null;
            }
        }
    </script>

</body>

</html>


