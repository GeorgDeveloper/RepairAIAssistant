<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair AI Assistant</title>
    <link rel="stylesheet" href="/static/styles/style.css">
</head>

<body>

    <div class="sidebar">
        <div class="logo">
            <img src="/static/images/LogoPirelli3.png" alt="Логотип компании">
        </div>

        <div class="nav-container">
            <ul class="nav-menu">
                <li class="has-submenu">
                    <a href="#">Инфопанель</a>
                    <ul class="submenu">
                        <li><a href="/dashboard">Показатели Online</a></li>
                        <li><a href="#">ИТОГИ</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="/">Главная</a>
                </li>
                <li class="has-submenu">
                    <a href="#">Поломки</a>
                    <ul class="submenu">
                        <li><a href="/dinamic_bd">Динамика</a></li>
                        <li><a href="/bdav">Динамика BD/AV</a></li>
                        <li><a href="/failures">Заявки на поломки</a></li>
                        <li><a href="/top-causes">Топ причин</a></li>
                        <li class="has-submenu">
                            <a href="/top-causes">Топ поломок</a>
                            <ul class="submenu">
                                <li><a href="/top-equipment">Оборудование</a></li>
                                <li><a href="/top_areas">Участки</a></li>
                            </ul>
                        </li>
                        <li><a href="/gantt">Диаграмма Ганта</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">ППР</a>
                    <ul class="submenu">
                        <li><a href="#">Динамика</a></li>
                        <li><a href="#">Отчеты</a></li>
                        <li><a href="#">Tag-PM-BD</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">Диагностика</a>
                    <ul class="submenu">
                        <li><a href="#">Отчёты</a></li>
                        <li><a href="#">Динамика</a></li>
                        <li><a href="#">Пневматика</a></li>
                        <li><a href="#">Чек-листы</a></li>
                        <li class="has-submenu">
                            <a href="#">Графики</a>
                            <ul class="submenu">
                                <li class="has-submenu">
                                    <a href="#">Год</a>
                                    <ul class="submenu">
                                        <li class="has-submenu">
                                            <a href="#">2025</a>
                                            <ul class="submenu">
                                                <li><a href="#">Январь</a></li>
                                                <li><a href="#">Февраль</a></li>
                                                <li><a href="#">Март</a></li>
                                                <li><a href="#">Апрель</a></li>
                                                <li><a href="#">Май</a></li>
                                                <li><a href="#">Июнь</a></li>
                                                <li><a href="#">Июль</a></li>
                                                <li><a href="#">Август</a></li>
                                                <li><a href="#">Сентябрь</a></li>
                                                <li><a href="#">Октябрь</a></li>
                                                <li><a href="#">Ноябрь</a></li>
                                                <li><a href="#">Декабрь</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">Ассистент KVANT AI </a>
                    <ul class="submenu">
                        <li><a href="/chat">Чат с ассистентом</a></li>
                        <li><a href="/long_report">Отчеты</a></li>
                        <li><a href="/manuals">Мануалы</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>


    <div class="total-content">
        <div class="header">
            <div class="user_logo">
                Привет, <a href="#">user</a>
            </div>
        </div>

        <div class="main-content">
            <style>
                .pm-row { display: grid; grid-template-columns: 1fr 1fr; grid-gap: 16px; }
                .pm-row .table-container, .pm-row .chart-container { height: 100%; }
                #resizablePm { height: 100% !important; }
            </style>
            <div class="container">
                <div class="content">
                    <h1>Отчеты о сложных ремонтах</h1>
                    <!-- Add a button to open the modal -->
                    <button id="openModalButton" class="showSolutionForm" style="margin-bottom: 20px;">Добавить
                        запись</button> <!-- Added margin-bottom to create space above the table -->

                    <!-- Modal structure -->
                    <div id="addSolutionModal" class="modal"
                        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center; z-index: 1000;">
                        <!-- Added z-index for proper stacking -->
                        <div class="modal-content"
                            style="background: white; padding: 20px; border-radius: 8px; width: 50%; max-width: 600px;">
                            <h2>Добавить запись</h2>
                            <form id="addSolutionForm" style="display: flex; flex-direction: column; gap: 8px;">
                                <input type="text" id="date" name="date" placeholder="Дата" required>
                                <input type="text" id="executor" name="executor" placeholder="Исполнитель" required>
                                <select id="region" name="region" required>
                                    <option value="">Выберите участок</option>
                                </select>
                                <select id="equipment" name="equipment" required>
                                    <option value="">Выберите оборудование</option>
                                </select>
                                <select id="node" name="node" required>
                                    <option value="">Выберите узел</option>
                                </select>
                                <textarea id="notes_on_the_operation_of_the_equipment"
                                    name="notes_on_the_operation_of_the_equipment"
                                    placeholder="Примечания по работе оборудования" required
                                    style="height: 100px; overflow-y: auto;"></textarea>
                                <textarea id="measures_taken" name="measures_taken" placeholder="Принятые меры" required
                                    style="height: 100px; overflow-y: auto;"></textarea>
                                <textarea id="comments" name="comments" placeholder="Комментарии" required
                                    style="height: 100px; overflow-y: auto;"></textarea>
                                <button type="submit">Добавить</button>
                                <button type="button" id="closeModalButton">Закрыть</button>
                            </form>
                        </div>
                    </div>

                    <script>
                        // Ensure modal open and close functionality works
                        document.addEventListener('DOMContentLoaded', () => {
                            const modal = document.getElementById('addSolutionModal');
                            const openModalButton = document.getElementById('openModalButton');
                            const closeModalButton = document.getElementById('closeModalButton');

                            openModalButton.addEventListener('click', () => {
                                modal.style.display = 'flex';
                            });

                            closeModalButton.addEventListener('click', () => {
                                modal.style.display = 'none';
                            });

                            // Close modal when clicking outside the content
                            window.addEventListener('click', (event) => {
                                if (event.target === modal) {
                                    modal.style.display = 'none';
                                }
                            });
                        });
                    </script>
                    <table id="solutionsTable" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Дата</th>
                                <th>Исполнитель</th>
                                <th>Участок</th>
                                <th>Оборудование</th>
                                <th>Узел</th>
                                <th>Примечания</th>
                                <th>Меры</th>
                                <th>Комментарии</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут подгружаться через JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- DataTables и jQuery -->
            <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
            <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
            <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
            <script>
                $(document).ready(function () {
                    // Инициализация таблицы
                    var table = $('#solutionsTable').DataTable({
                        ajax: {
                            url: '/api/summary-of-solutions',
                            dataSrc: ''
                        },
                        columns: [
                            { data: 'id' },
                            { data: 'date' },
                            { data: 'executor' },
                            { data: 'region' },
                            { data: 'equipment' },
                            { data: 'node' },
                            { data: 'notes_on_the_operation_of_the_equipment' },
                            { data: 'measures_taken' },
                            { data: 'comments' },
                            {
                                data: null,
                                render: function (data, type, row) {
                                    return `
                                        <button class='edit-button' data-id='${row.id}'>Редактировать</button>
                                        <button class='delete-button' data-id='${row.id}'>Удалить</button>
                                    `;
                                }
                            }
                        ],
                        language: {
                            search: "Поиск:",
                            lengthMenu: "Показать _MENU_ записей",
                            info: "Показано с _START_ по _END_ из _TOTAL_ записей",
                            paginate: { first: "Первая", last: "Последняя", next: "Следующая", previous: "Предыдущая" }
                        }
                    });

                    table.order([0, 'desc']).draw();

                    // Добавление записи
                    $('#addSolutionForm').on('submit', function (e) {
                        e.preventDefault();

                        const date = $('#date');
                        const executor = $('#executor');
                        const region = $('#region');
                        const equipment = $('#equipment');
                        const node = $('#node');
                        const notes = $('#notes_on_the_operation_of_the_equipment');
                        const measures = $('#measures_taken');
                        const comments = $('#comments');

                        if (!date.val().trim()) {
                            alert('Поле "Дата" обязательно для заполнения.');
                            date.focus();
                            return;
                        }

                        if (!executor.val().trim()) {
                            alert('Поле "Исполнитель" обязательно для заполнения.');
                            executor.focus();
                            return;
                        }

                        if (!region.val().trim()) {
                            alert('Поле "Участок" обязательно для заполнения.');
                            region.focus();
                            return;
                        }

                        if (!equipment.val().trim()) {
                            alert('Поле "Оборудование" обязательно для заполнения.');
                            equipment.focus();
                            return;
                        }

                        if (!node.val().trim()) {
                            alert('Поле "Узел" обязательно для заполнения.');
                            node.focus();
                            return;
                        }

                        if (!notes.val().trim()) {
                            alert('Поле "Примечания по работе оборудования" обязательно для заполнения.');
                            notes.focus();
                            return;
                        }

                        if (!measures.val().trim()) {
                            alert('Поле "Принятые меры" обязательно для заполнения.');
                            measures.focus();
                            return;
                        }

                        if (!comments.val().trim()) {
                            alert('Поле "Комментарии" обязательно для заполнения.');
                            comments.focus();
                            return;
                        }

                        // Если все проверки пройдены, отправляем данные
                        const data = {
                            date: date.val(),
                            executor: executor.val(),
                            region: $('#region option:selected').text(), // Получаем текст выбранного option
                            equipment: $('#equipment option:selected').text(), // Получаем текст выбранного option
                            node: $('#node option:selected').text(), // Получаем текст выбранного option
                            notes_on_the_operation_of_the_equipment: notes.val(),
                            measures_taken: measures.val(),
                            comments: comments.val()
                        };

                        $.ajax({
                            url: '/api/summary-of-solutions',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(data),
                            success: function () {
                                $('#solutionsTable').DataTable().ajax.reload();
                                $('#addSolutionForm')[0].reset();
                                $('#addSolutionModal').hide(); // Закрытие модального окна
                            },
                            error: function () {
                                alert('Ошибка при добавлении записи');
                            }
                        });
                    });

                    // Загрузка данных для списка регионов
                    fetch('/api/regions')
                        .then(response => response.json())
                        .then(data => {
                            const regionSelect = $('#region');
                            data.forEach(region => {
                                regionSelect.append(new Option(region.name_region, region.id));
                            });
                        });

                    // Обновление списка оборудования при выборе региона
                    $('#region').on('change', function () {
                        const regionId = $(this).val();
                        const equipmentSelect = $('#equipment');
                        equipmentSelect.empty().append(new Option('Выберите оборудование', ''));

                        if (regionId) {
                            fetch(`/api/equipment?regionId=${regionId}`)
                                .then(response => response.json())
                                .then(data => {
                                    data.forEach(equipment => {
                                        equipmentSelect.append(new Option(equipment.name_equipment, equipment.id));
                                    });
                                });
                        }
                    });

                    // Обновление списка узлов при выборе оборудования
                    $('#equipment').on('change', function () {
                        const equipmentId = $(this).val();
                        const nodeSelect = $('#node');
                        nodeSelect.empty().append(new Option('Выберите узел', ''));

                        if (equipmentId) {
                            fetch(`/api/nodes?equipmentId=${equipmentId}`)
                                .then(response => response.json())
                                .then(data => {
                                    data.forEach(node => {
                                        nodeSelect.append(new Option(node.name_node, node.id));
                                    });
                                });
                        }
                    });

                    // Редактирование и удаление записей
                    $(document).on('click', '.delete-button', function () {
                        const id = $(this).data('id');
                        if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                            // Добавлены заголовки в запрос DELETE для summary-of-solutions
                            fetch(`/api/summary-of-solutions/${id}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                }
                            })
                                .then(() => $('#solutionsTable').DataTable().ajax.reload())
                                .catch(error => alert('Ошибка при удалении: ' + error.message));
                        }
                    });

                    $(document).on('click', '.edit-button', function () {
                        const id = $(this).data('id');

                        // Получение текущих данных записи с сервера
                        fetch(`/api/summary-of-solutions/${id}`)
                            .then(response => response.json())
                            .then(data => {
                                // Заполнение модального окна текущими данными
                                $('#date').val(data.date);
                                $('#executor').val(data.executor);
                                $('#region').val(data.region).trigger('change');
                                $('#equipment').val(data.equipment).trigger('change');
                                $('#node').val(data.node);
                                $('#notes_on_the_operation_of_the_equipment').val(data.notes_on_the_operation_of_the_equipment);
                                $('#measures_taken').val(data.measures_taken);
                                $('#comments').val(data.comments);

                                // Показ модального окна
                                $('#addSolutionModal').css('display', 'flex');

                                // Изменение логики кнопки "Добавить" на "Сохранить"
                                const submitButton = $('#addSolutionForm button[type="submit"]');
                                submitButton.text('Сохранить');

                                // Удаление предыдущего обработчика и добавление нового для обновления записи
                                $('#addSolutionForm').off('submit').on('submit', function (e) {
                                    e.preventDefault();

                                    const updatedData = {
                                        date: $('#date').val(),
                                        executor: $('#executor').val(),
                                        region: $('#region option:selected').text(), // Получаем текст выбранного option
                                        equipment: $('#equipment option:selected').text(), // Получаем текст выбранного option
                                        node: $('#node option:selected').text(), // Получаем текст выбранного option
                                        notes_on_the_operation_of_the_equipment: $('#notes_on_the_operation_of_the_equipment').val(),
                                        measures_taken: $('#measures_taken').val(),
                                        comments: $('#comments').val()
                                    };

                                    // Отправка PUT-запроса на сервер
                                    fetch(`/api/summary-of-solutions/${id}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(updatedData)
                                    })
                                        .then(() => {
                                            $('#solutionsTable').DataTable().ajax.reload(); // Обновление таблицы
                                            $('#addSolutionModal').hide(); // Закрытие модального окна
                                            $('#addSolutionForm')[0].reset(); // Очистка формы
                                            submitButton.text('Добавить'); // Возврат текста кнопки
                                        })
                                        .catch(error => alert('Ошибка при обновлении записи: ' + error.message));
                                });
                            })
                            .catch(error => alert('Ошибка при загрузке данных для редактирования: ' + error.message));
                    });
                });
            </script>
        </div>
    </div>
    </div>
    </div>
</body>

</html>
